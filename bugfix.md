---
description: 修复 Bug
---

## 一、User Input

```text
1. 加载以下提示词文档（按顺序，遵循 doc_loader.md 规则）：
   - ${old_base}
   - ${git_rules}
   - ${codestyle}
   - ${constitution}（如存在，项目级基础规则）

2. 我将提供一个 Bug 相关信息，可能包含：
   - 复现步骤 / 期望与实际行为
   - 报错日志 / 堆栈 / 监控告警
   - 截图 / 图片 / 视频
   - 相关代码片段
   - 文档或网页链接 / Issue 描述

3. 请你严格按照本文档流程，
   以最小改动、可验证的方式完成 Bug 修复任务：

   $ARGUMENTS
````

### 前置环境检查（强制）

- 遵循 `git_rules` 中的 Git 规则
- 确认输出目录 `./mydoc/{date}-{taskname}/` 可写，不存在则创建: 当前任务的简短代号（若用户未提供，直接自动生成，不必询问）
- 按 doc_loader 规则检查所需 prompt 是否可读取，缺失时必须暂停并告知
- 若修复涉及数据模型/存储或迁移，需额外加载并遵循 `data_rule`

---

## 二、总体原则（强制）

```
- 严格按阶段执行，不跳步
- 默认最小改动原则
- 禁止顺手重构或结构性调整（除非明确升级）
- 先理解与定位，再修复
- 优先使用测试或最小复现约束修复
- 不可复现的 Bug 允许基于证据推断推进
- Root Cause 不强求，但尽量给出
```

### OpenAPI 规范约束（强制）

**OpenAPI 规范是 API 接口定义的唯一真源（Single Source of Truth）**

* 若 Bug 涉及 API 接口：
  * 必须首先查找并引用对应的 OpenAPI 规范文件
  * 以 OpenAPI 规范为准判断接口行为是否正确
  * 若代码实现与 OpenAPI 规范不一致：
    - 以 OpenAPI 规范为准
    - 必须修正代码实现以符合 OpenAPI 规范
* 修复 API 相关 Bug 时：
  * 必须确保修复后的实现符合 OpenAPI 规范
  * 若修复涉及接口变更，必须同步更新 OpenAPI 规范文件
* 在 framework.md 中记录 API 相关问题时：
  * 必须标注对应的 OpenAPI 规范路径和操作 ID
  * 格式：`[OpenAPI: {file_path}#/{operationId}]`

---

## 三、阶段 0：输入确认与复现策略

### 0.1 信息归类

明确当前输入包含哪些类型：

* 现象描述 / 复现步骤
* 日志 / 堆栈 / 告警
* 截图 / 图片
* 代码片段
* 链接 / 文档

---

### 0.2 可复现性判定

* **可复现**

    * 记录最小复现步骤
* **不可复现**

    * 进入「证据推断模式」
    * 明确依据的证据与假设（Assumptions）

> 若存在关键信息缺失（最多 5 个澄清点），必须先与我澄清。

---

## 四、阶段 1：问题理解（禁止修复）

仅描述问题本身，不给解决方案。

写入 `framework.md`：

```markdown
## Bug 理解

### 1. 现象（Observed）
- ...

### 2. 期望行为（Expected）
- ...

### 3. 实际行为（Actual）
- ...

### 4. 影响范围（Impact）
- 功能 / 用户 / 数据 / 稳定性 / 性能
- 是否疑似回归（如有依据）

### 5. 复现策略
- 可复现 / 不可复现（证据推断）
- 复现步骤或证据清单
- Assumptions（如有）
```

---

## 五、阶段 2：现有逻辑定位与原因分析（核心）

### 2.1 定位要求（强制）

* 定位相关代码路径（入口 → 关键分支 → 出错点）
* 解释**当前逻辑为何会产生该 Bug**
* 尽量区分：

    * 触发原因（Trigger）
    * 根本原因（Root Cause，尽量提供）

---

### 2.2 输出（写入 framework.md）

```markdown
## 定位与原因分析

### 1. 相关代码路径
- 入口：
- 关键流程：
- 出错点：

### 2. 直接原因（Trigger）
- ...

### 3. 根本原因（Root Cause，尽量提供）
- ...

### 4. 是否回归（Regression）
- 是 / 否 / 不确定
- 依据：
```

---

## 六、阶段 3：修复策略选择（不等于立刻改代码）

### 3.1 默认修复策略

* 局部修改现有逻辑
* 不新增模块、不引入新抽象
* 不改变公共接口语义

---

### 3.2 输出（写入 framework.md）

```markdown
## 修复策略

### 1. 候选方案
- 方案 A：
  - 改动点：
  - 影响范围：
  - 风险评估：

### 2. 推荐方案
- 选择：
- 理由：
```

---

## 七、阶段 4：验证用例（先于实现）

### 4.1 验证优先级

1. 单元测试
2. 集成测试
3. 最小复现代码 / 脚本
4. 人工验证步骤（需说明原因）
5. 主流程 E2E（优先使用 chrome MCP server）+ 全部单元测试通过视为通过标准；若无法落地需说明原因并暂停确认

---

### 4.2 输出（写入 framework.md 或 task.md）

```markdown
## 验证用例

### 1. Bug 复现用例
- 描述：
- 输入：
- 期望结果：
- 当前结果（修复前）：

### 2. 回归关注点
- ...
```

---

## 八、阶段 5：任务拆解 & MVP（Bugfix）

### 5.1 task.md 要求

* 拆分为最小 todo
* 每项包含：

    * 目的
    * 改动点
    * 验收标准
    * 验证方式
    * 状态

---

### 5.2 MVP 定义（Bugfix）

* MVP = Bug 被修复 + 相邻逻辑未破坏
* 明确验证步骤与成功标准

---

## 九、阶段 6：实现修复（受控推进）

### 6.1 实现规则

* 严格遵循 `codestyle.md`
* 只做已选定的修复策略
* 不引入无关变更
* 每完成一个 todo：

    * 更新 task.md 状态
    * 记录实现与验证结果
    * 自动开始下一个 todo

---

### 6.2 升级规则（非常重要）

若在实现过程中确认：

* 无法通过局部修改修复
* 必须引入新实现或新抽象

**必须暂停并与我确认是否升级为：**

* 新实现级 Bugfix
加载以下提示词文档 ${new_base}（遵循 doc_loader.md 规则） 后重新规划

---

## 十、阶段 7：回归检查与总结（轻量）

### 10.1 回归检查（强制）

* Bug 场景验证通过
* 相邻路径检查通过
* 主流程 E2E（chrome MCP server 优先）通过，全部单元测试通过；否则需暂停并澄清

---

### 10.2 总结（尽量提供 Root Cause）

写入 `framework.md`：

```markdown
## 回归与总结

- 修复结果：
- 验证方式：
- Bug 原因（如有）：
- 是否需要补充测试 / 文档 / 监控：
```

---

## 十一、输出结构（真实落盘）

```text
./mydoc/
├── catalog.md
└── {date}-{taskname}/
    ├── framework.md   # Bug 理解 / 定位 / 策略 / 验证 / 总结
    └── task.md        # todo / MVP / 状态
```
